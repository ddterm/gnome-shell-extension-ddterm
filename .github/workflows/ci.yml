# SPDX-FileCopyrightText: 2025 Aleksandr Mezin <mezin.alexander@gmail.com>
#
# SPDX-License-Identifier: CC0-1.0

name: ci

on:
  workflow_call:
    inputs:
      push:
        type: boolean
        description: Push autogenerated changes
        default: false

    outputs:
      version:
        description: Meson project version
        value: ${{ jobs.bundle.outputs.version }}

defaults:
  run:
    shell: bash

permissions:
  contents: read

env:
  FORCE_COLOR: 1
  PIP_DISABLE_PIP_VERSION_CHECK: 1
  TERM: xterm-color
  TQDM_DISABLE: 1
  DEVTOOLS_COLOR: always

jobs:
  plan:
    runs-on: ubuntu-slim
    timeout-minutes: 5
    needs:
      - bundle
      - lint

    outputs:
      need-tests: ${{ steps.diff.outputs.changed != 'false' }}
      test-containers: ${{ steps.test-config.outputs.containers }}

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - id: actions
        name: Get the list of actions used in build and test jobs
        run: |
          names="$(yq -oj -I0 "$YQ_FILTER" .github/workflows/ci.yml)"
          echo "names=$names" | tee -a "$GITHUB_OUTPUT"
        env:
          YQ_FILTER: >-
            [
              .jobs["bundle", "test", "archlinux-package", "archlinux-package-check", "archlinux-installed-test"] |
              .steps.[].uses |
              select(.) |
              capture("^\\./\\.github/actions/(?<name>.*)$") |
              .name
            ] | unique

      - id: diff
        name: Check if tests are necessary
        uses: amezin/detect-changes-action@28c15fa5ce53655f33b1e2a666faae356c010f04 # v2.2.1
        continue-on-error: true
        with:
          files: |
            ${{ needs.bundle.outputs.build-inputs }}

            # Files that influence build and test, even though they aren't included in the package
            .github/actions/{${{ join(fromJSON(steps.actions.outputs.names)) }}}/**
            .github/workflows/ci.yml
            requirements/{test,test-images,meson}.txt
            tests/**
            tools/heapgraph.py
            pytest.ini
            tox.ini
            PKGBUILD

            # Exclude any documentation and translations
            !**/*.md
            !**/*.license
            !**/REUSE.toml
            !LICENSES/**
            !po/**

            # Include meson.build files, even from po/ directory
            **/meson.build
            meson.options
            subprojects/*.wrap

      - id: test-config
        name: Determine test configurations
        working-directory: tests
        run: |
          containers="$(yq -oj -I0 "$YQ_FILTER" compose.yaml)"
          echo "containers=$containers" | tee -a "$GITHUB_OUTPUT"
        env:
          YQ_FILTER: >-
            [ .services | keys.[] | select(. != "archlinux") ]

  lint:
    runs-on: ubuntu-24.04
    timeout-minutes: 5

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Configure APT
        uses: ./.github/actions/apt-init

      - id: apt
        run: sudo apt-get install -y --no-install-recommends tox

      - name: Install development dependencies from npm
        id: npm
        uses: ./.github/actions/npm-install
        if: ${{ !cancelled() && steps.checkout.outcome == 'success' }}

      - name: Install Python dependencies
        id: pip
        uses: ./.github/actions/tox-preinstall
        with:
          environments: reuse,flake8,meson-format,pip-compile
        if: ${{ !cancelled() && steps.apt.outcome == 'success' }}

      - name: Lint JS code with ESLint
        uses: ./.github/actions/eslint
        if: ${{ !cancelled() && steps.npm.outcome == 'success' }}

      - name: Lint Python code with flake8
        uses: ./.github/actions/flake8
        if: ${{ !cancelled() && steps.pip.outcome == 'success' }}

      - name: Lint Markdown files
        uses: ./.github/actions/markdownlint
        if: ${{ !cancelled() && steps.npm.outcome == 'success' }}

      - name: Check repository REUSE compliance
        uses: ./.github/actions/reuse
        if: ${{ !cancelled() && steps.pip.outcome == 'success' }}

      - name: Check meson.build formatting
        uses: ./.github/actions/meson-format
        if: ${{ !cancelled() && steps.pip.outcome == 'success' }}

      - name: Check Python requirements .txt files
        uses: ./.github/actions/pip-compile
        if: ${{ !cancelled() && steps.pip.outcome == 'success' }}

      - name: Check PICT test cases
        uses: ./.github/actions/pict
        if: ${{ !cancelled() && steps.checkout.outcome == 'success' }}

      - name: Add flake8 to PATH
        run: echo "$GITHUB_WORKSPACE/.tox/flake8/bin" >>"$GITHUB_PATH"
        if: ${{ !cancelled() && steps.pip.outcome == 'success' }}

      - name: Check GitHub Actions workflows
        uses: ./.github/actions/actionlint
        if: ${{ !cancelled() && steps.checkout.outcome == 'success' }}

  bundle:
    runs-on: ubuntu-24.04
    timeout-minutes: 5

    outputs:
      build-inputs: ${{ steps.ninja-inputs.outputs.inputs }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Configure APT
        uses: ./.github/actions/apt-init

      - run: sudo apt-get install -y --no-install-recommends tox colorized-logs gjs gettext desktop-file-utils

      - name: Install meson
        uses: ./.github/actions/setup-meson

      - name: Prepare build directory
        run: meson setup '-Dshebang_override=/usr/bin/env gjs' '-Dtests=disabled' '-Dtypelib_installer=true' build
        shell: pipetty bash -e {0}

      - name: Get project version
        id: version
        working-directory: build
        run: |
          version="$(jq -r '.version' meson-info/intro-projectinfo.json)"
          echo "version=$version" | tee -a "$GITHUB_OUTPUT"

      - name: Build extension bundle
        id: pack
        run: ninja -j1 bundle
        working-directory: build

      - name: Upload extension bundle as artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ github.job }}
          path: "build/*.shell-extension.zip"
          if-no-files-found: error
        if: ${{ !cancelled() && steps.pack.outcome == 'success' }}

      - name: Run checks
        run: meson test -v -j1
        working-directory: build
        shell: pipetty bash -e {0}
        if: ${{ !cancelled() && steps.pack.outcome == 'success' }}

      - name: Check REUSE compliance of generated bundle
        run: tox -e reuse-bundle -- build/*.shell-extension.zip
        if: ${{ !cancelled() && steps.pack.outcome == 'success' }}

      - name: Generate a list of input files
        id: ninja-inputs
        working-directory: build
        run: |
          inputs="$(ninja -t inputs | xargs realpath "--relative-base=$GITHUB_WORKSPACE" | grep -v '^build/')"
          { echo "inputs<<../EOF"; echo "$inputs"; echo "../EOF"; } | tee -a "$GITHUB_OUTPUT"

  update-translations:
    needs:
      - lint
      - bundle

    runs-on: ubuntu-24.04
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Configure APT
        uses: ./.github/actions/apt-init

      - run: sudo apt-get install -y --no-install-recommends tox colorized-logs gettext libgtk-3-bin

      - name: Install meson
        uses: ./.github/actions/setup-meson

      - name: Prepare build directory
        id: setup
        run: meson setup '-Dshebang_override=/usr/bin/env gjs' '-Dtests=disabled' '-Dtypelib_installer=false' build
        shell: pipetty bash -e {0}

      - name: Update POTFILES.in
        run: ninja -j1 potfiles
        working-directory: build

      - name: Update .pot file
        run: ninja -j1 pot
        working-directory: build

      - name: Update .po files
        run: ninja -j1 msgmerge
        working-directory: build

      - name: Diff
        id: diff
        # Note: git diff --name-only ignores --ignore-matching-lines arg
        run: |
          git diff --color '--ignore-matching-lines=^"POT-Creation-Date: ' 'po/*.po' 'po/*.pot' 'po/POTFILES.in' | tee "$RUNNER_TEMP/po.diff"
          size="$(stat --printf=%s "$RUNNER_TEMP/po.diff")"
          echo "size=$size" | tee -a "$GITHUB_OUTPUT"

      - name: Create pull request
        if: vars.APP_ID && fromJSON(steps.diff.outputs.size) && inputs.push
        uses: ./.github/actions/pull-request
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_KEY }}
          title: 'translations: update translation files'
          description: 'Update translation files. Before merging this, make sure there are no unmerged changes from Weblate.'
          files: |
            po/*.po
            po/*.pot
            po/POTFILES.in

  test:
    needs:
      - plan
      - bundle
      - lint

    strategy:
      fail-fast: false
      matrix:
        container: ${{ fromJSON(needs.plan.outputs.test-containers) }}

    if: fromJSON(needs.plan.outputs.need-tests)
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    env:
      VIRTUALENV_SYSTEM_SITE_PACKAGES: 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Configure APT
        uses: ./.github/actions/apt-init

      - run: sudo apt-get install -y --no-install-recommends tox python3-gi

      - name: Download extension bundle
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: bundle

      - name: Install dependencies
        uses: ./.github/actions/tox-preinstall
        with:
          environments: pytest,images

      - name: Run tests
        uses: ./.github/actions/container-test
        with:
          container: ${{ matrix.container }}
          args: >-
            ${{ !contains(matrix.container, 'alpine') && '--journald' || '' }}
            --bundle=ddterm@amezin.github.com.shell-extension.zip

  archlinux-package:
    needs:
      - plan
      - bundle
      - lint

    runs-on: ubuntu-24.04
    timeout-minutes: 10
    container:
      image: ghcr.io/archlinux/archlinux:base-devel-20260215.0.491140@sha256:6f57bd0d00cad35e4393664bf9e8e0167e8c4275afb88850afaac137f16c5d9b
      options: --privileged --tmpfs /run

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0  # for pkgver()

      - name: Create build chroot
        uses: ./.github/actions/mkarchroot

      - name: Build package
        uses: ./.github/actions/makechrootpkg
        with:
          makepkg-args: --nocheck

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ github.job }}
          path: |
            *.pkg.tar.*
            *.log
          if-no-files-found: error

      - id: pkgfilename
        shell: bash -e -O extglob {0}
        run: |
          pkgfilename="$(echo -n *.pkg.tar@(|.+([^.])))"
          echo "pkgfilename=$pkgfilename" | tee -a "$GITHUB_OUTPUT"

    outputs:
      pkgfilename: ${{ steps.pkgfilename.outputs.pkgfilename }}

  archlinux-installed-test:
    needs:
      - plan
      - archlinux-package

    if: fromJSON(needs.plan.outputs.need-tests)
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    env:
      VIRTUALENV_SYSTEM_SITE_PACKAGES: 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Configure APT
        uses: ./.github/actions/apt-init

      - run: sudo apt-get install -y --no-install-recommends tox python3-gi

      - name: Download extension package
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: archlinux-package

      - name: Install dependencies
        uses: ./.github/actions/tox-preinstall
        with:
          environments: pytest,images

      - name: Run tests
        uses: ./.github/actions/container-test
        with:
          container: archlinux
          args: --journald "--sys-package=$PKGFILENAME"
        env:
          PKGFILENAME: ${{ needs.archlinux-package.outputs.pkgfilename }}

  archlinux-package-check:
    needs:
      - plan
      - archlinux-package

    if: fromJSON(needs.plan.outputs.need-tests)
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    container:
      image: ghcr.io/archlinux/archlinux:base-devel-20260215.0.491140@sha256:6f57bd0d00cad35e4393664bf9e8e0167e8c4275afb88850afaac137f16c5d9b
      options: --privileged --tmpfs /run --security-opt apparmor=unconfined

    steps:
      - name: Allow unprivileged userns in AppArmor
        run: |
          # https://ubuntu.com/blog/ubuntu-23-10-restricted-unprivileged-user-namespaces
          sysctl -w kernel.apparmor_restrict_unprivileged_unconfined=0
          sysctl -w kernel.apparmor_restrict_unprivileged_userns=0

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0  # for pkgver()

      - name: Create build chroot
        uses: ./.github/actions/mkarchroot

      - name: Build package
        uses: ./.github/actions/makechrootpkg
        with:
          makepkg-args: --check

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ github.job }}
          path: |
            *.pkg.tar.*
            *.log
          if-no-files-found: error

  testspace-publish:
    needs:
      - plan
      - test
      - archlinux-installed-test

    if: always() && fromJSON(needs.plan.outputs.need-tests) && !github.event.repository.fork
    runs-on: ubuntu-slim
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: testspace-com/setup-testspace@5fc620521eddeba83c1c0dd58f5a524adf474c93 # v1.0.8
        with:
          domain: ${{ github.repository_owner }}

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: '*-reports'

      - run: |
          res=0
          how="?start"

          for dir in *-reports; do
            name="${dir%-reports}"
            testspace --verbose push "[$name]./$dir/junit.xml" "[$name]+./$dir/report.html" "$how" || res="$?"
            how="?add"
          done

          testspace --verbose push "?finish"
          exit "$res"
