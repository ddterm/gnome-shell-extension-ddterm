# SPDX-FileCopyrightText: 2025 Aleksandr Mezin <mezin.alexander@gmail.com>
#
# SPDX-License-Identifier: CC0-1.0

name: ci

on:
  workflow_call:
    inputs:
      push:
        type: boolean
        description: Push autogenerated changes
        default: false
    outputs:
      pages:
        description: Whether pages were generated successfully
        value: ${{ jobs.pages.result == 'success' }}

defaults:
  run:
    shell: bash

permissions:
  contents: read

env:
  FORCE_COLOR: 1
  PIP_DISABLE_PIP_VERSION_CHECK: 1
  VIRTUALENV_SYSTEM_SITE_PACKAGES: 'true'
  TERM: xterm-color
  TQDM_DISABLE: 1
  DEVTOOLS_COLOR: always

jobs:
  plan:
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    needs:
      - extension-package
      - lint

    outputs:
      need-tests: ${{ steps.diff.outputs.changed != 'false' }}
      testspace: ${{ steps.diff.outputs.changed != 'false' && !github.event.repository.fork }}
      test-containers: ${{ steps.test-config.outputs.containers }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - id: diff
        name: Check if tests are necessary
        uses: amezin/compare-commit-files-action@ffa4731f9853fe8dd1f14e0adb7ace7185560ded # v1.0.1
        continue-on-error: true
        with:
          files: |
            ${{ needs.extension-package.outputs.build-inputs }}

            # Files that influence build and test, even though they aren't included in the package
            .github/workflows/ci.yml
            .github/actions/{container-test,setup-meson,tox-preinstall,makechrootpkg,mkarchroot}/**
            requirements/{test,test-images,meson}.txt
            tests/**
            tools/heapgraph.py
            pytest.ini
            tox.ini
            PKGBUILD

            # Exclude any documentation and translations
            !**/*.md
            !**/*.license
            !**/REUSE.toml
            !LICENSES/**
            !po/**

            # Include meson.build files, even from po/ directory
            **/meson.build
            meson_options.txt

      - id: test-config
        name: Determine test configurations
        working-directory: tests
        run: >-
          echo "containers=$(docker compose config --services | grep -v archlinux | sort | jq -cnR '[inputs]')" >>"$GITHUB_OUTPUT"

  lint:
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    container:
      image: ghcr.io/ddterm/ci-docker-image:2025.06.16.0

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - run: git config --global --replace-all safe.directory "$GITHUB_WORKSPACE"

      - name: Install development dependencies from npm
        id: npm
        uses: ./.github/actions/npm-install
        if: ${{ !cancelled() && steps.checkout.outcome == 'success' }}

      - name: Install Python dependencies
        id: pip
        uses: ./.github/actions/tox-preinstall
        with:
          environments: reuse,version,flake8,meson-format,pip-compile
        if: ${{ !cancelled() && steps.checkout.outcome == 'success' }}

      - name: Lint JS code with ESLint
        uses: ./.github/actions/eslint
        if: ${{ !cancelled() && steps.npm.outcome == 'success' }}

      - name: Lint Python code with flake8
        uses: ./.github/actions/flake8
        if: ${{ !cancelled() && steps.pip.outcome == 'success' }}

      - name: Lint Markdown files
        uses: ./.github/actions/markdownlint
        if: ${{ !cancelled() && steps.npm.outcome == 'success' }}

      - name: Check repository REUSE compliance
        uses: ./.github/actions/reuse
        if: ${{ !cancelled() && steps.pip.outcome == 'success' }}

      - name: Check meson.build formatting
        uses: ./.github/actions/meson-format
        if: ${{ !cancelled() && steps.pip.outcome == 'success' }}

      - name: Check Python requirements .txt files
        uses: ./.github/actions/pip-compile
        if: ${{ !cancelled() && steps.pip.outcome == 'success' }}

      - name: Check version number
        run: tox -e version
        if: ${{ !cancelled() && steps.pip.outcome == 'success' }}

      - name: Check PICT test cases
        uses: ./.github/actions/pict
        if: ${{ !cancelled() && steps.checkout.outcome == 'success' }}

  extension-package:
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    container:
      image: ghcr.io/ddterm/ci-docker-image:2025.06.16.0

    outputs:
      build-inputs: ${{ steps.ninja-inputs.outputs.inputs }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - run: git config --global --replace-all safe.directory "$GITHUB_WORKSPACE"

      - name: Install meson
        uses: ./.github/actions/setup-meson

      - name: Prepare build directory
        run: meson setup '-Dshebang_override=/usr/bin/env gjs' '-Dtests=disabled' build
        shell: pipetty bash -e {0}

      - name: Build extension package
        id: pack
        run: xvfb-run -d --server-args=-noreset --wait=0 -- ninja -j1 pack
        working-directory: build

      - name: Upload extension package as artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ github.job }}
          path: "build/*.shell-extension.zip"
          if-no-files-found: error
        if: ${{ !cancelled() && steps.pack.outcome == 'success' }}

      - name: Run checks
        run: xvfb-run -d --server-args=-noreset --wait=0 -- meson test -v -j1
        working-directory: build
        shell: pipetty bash -e {0}
        if: ${{ !cancelled() && steps.pack.outcome == 'success' }}

      - name: Check REUSE compliance of generated package
        run: tox -e reuse-pack -- build/*.shell-extension.zip
        if: ${{ !cancelled() && steps.pack.outcome == 'success' }}

      - name: Generate a list of input files
        id: ninja-inputs
        run: >-
          {
            echo "inputs<<$EOF";
            ninja -t inputs | xargs realpath "--relative-base=$GITHUB_WORKSPACE";
            echo "$EOF";
          } >>"$GITHUB_OUTPUT"
        working-directory: build
        env:
          EOF: ../EOF

  update-translations:
    needs:
      - lint
      - extension-package

    runs-on: ubuntu-24.04
    timeout-minutes: 5
    container:
      image: ghcr.io/ddterm/ci-docker-image:2025.06.16.0

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - run: git config --global --replace-all safe.directory "$GITHUB_WORKSPACE"

      - name: Install meson
        uses: ./.github/actions/setup-meson

      - name: Prepare build directory
        id: setup
        run: meson setup '-Dtests=disabled' build
        shell: pipetty bash -e {0}

      - name: Update POTFILES.in
        run: ninja -j1 potfiles
        working-directory: build

      - name: Update .pot file
        run: ninja -j1 pot && ninja -j1 pot-set-year
        working-directory: build

      - name: Update .po files
        run: for pofile in ./*.po; do msgmerge --no-wrap --update --previous "$pofile" ./*.pot; done
        working-directory: po

      - name: Diff
        id: diff
        # Note: git diff --name-only ignores --ignore-matching-lines arg
        run: |
          git diff --color '--ignore-matching-lines=^"POT-Creation-Date: ' 'po/*.po' 'po/*.pot' 'po/POTFILES.in' | tee "$RUNNER_TEMP/po.diff"
          echo "size=$(stat --printf=%s "$RUNNER_TEMP/po.diff")" >>"$GITHUB_OUTPUT"

      - name: Create pull request
        if: vars.APP_ID && fromJSON(steps.diff.outputs.size) && github.secret_source == 'Actions' && inputs.push
        uses: ./.github/actions/pull-request
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_KEY }}
          title: 'translations: update translation files'
          description: 'Update translation files. Before merging this, make sure there are no unmerged changes from Weblate.'
          files: |
            po/*.po
            po/*.pot
            po/POTFILES.in

  test:
    needs:
      - plan
      - extension-package
      - lint

    strategy:
      fail-fast: false
      matrix:
        container: ${{ fromJSON(needs.plan.outputs.test-containers) }}

    if: fromJSON(needs.plan.outputs.need-tests)
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    container:
      image: ghcr.io/ddterm/ci-docker-image:2025.06.16.0
      options: --init --privileged --tmpfs /run -v /tmp:/tmp --cgroupns=host

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - run: git config --global --replace-all safe.directory "$GITHUB_WORKSPACE"

      - name: Download extension package
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: extension-package

      - name: Install dependencies
        uses: ./.github/actions/tox-preinstall
        with:
          environments: pytest,images

      - name: Run tests
        uses: ./.github/actions/container-test
        with:
          container: ${{ matrix.container }}
          testspace: ${{ needs.plan.outputs.testspace }}
          args: >-
            ${{ !contains(matrix.container, 'alpine') && '--journald' || '' }}
            --package=ddterm@amezin.github.com.shell-extension.zip

  archlinux-package:
    needs:
      - plan
      - extension-package
      - lint

    runs-on: ubuntu-24.04
    timeout-minutes: 10
    container:
      image: ghcr.io/archlinux/archlinux:base-devel
      options: --privileged --tmpfs /run

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0  # for pkgver()

      - name: Create build chroot
        uses: ./.github/actions/mkarchroot

      - name: Build package
        uses: ./.github/actions/makechrootpkg
        with:
          makepkg-args: --nocheck

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ github.job }}
          path: |
            *.pkg.tar.*
            *.log
          if-no-files-found: error

      - id: pkgfilename
        run: echo "pkgfilename=$(echo -n *.pkg.tar@(|.+([^.])))" >>"$GITHUB_OUTPUT"
        shell: bash -e -O extglob {0}

    outputs:
      pkgfilename: ${{ steps.pkgfilename.outputs.pkgfilename }}

  archlinux-installed-test:
    needs:
      - plan
      - archlinux-package

    if: fromJSON(needs.plan.outputs.need-tests)
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    container:
      image: ghcr.io/ddterm/ci-docker-image:2025.06.16.0
      options: --init --privileged --tmpfs /run -v /tmp:/tmp --cgroupns=host

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - run: git config --global --replace-all safe.directory "$GITHUB_WORKSPACE"

      - name: Download extension package
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: archlinux-package

      - name: Install dependencies
        uses: ./.github/actions/tox-preinstall
        with:
          environments: pytest,images

      - name: Run tests
        uses: ./.github/actions/container-test
        with:
          container: archlinux
          testspace: ${{ needs.plan.outputs.testspace }}
          args: --journald "--sys-package=$PKGFILENAME"
        env:
          PKGFILENAME: ${{ needs.archlinux-package.outputs.pkgfilename }}

  archlinux-package-check:
    needs:
      - plan
      - archlinux-package

    if: fromJSON(needs.plan.outputs.need-tests)
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    container:
      image: ghcr.io/archlinux/archlinux:base-devel
      options: --privileged --tmpfs /run

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0  # for pkgver()

      - name: Create build chroot
        uses: ./.github/actions/mkarchroot

      - name: Build package
        uses: ./.github/actions/makechrootpkg
        with:
          makepkg-args: --check

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ github.job }}
          path: |
            *.pkg.tar.*
            *.log
          if-no-files-found: error

  pages:
    needs:
      - extension-package
      - test
      - archlinux-package
      - archlinux-package-check
      - archlinux-installed-test

    if: ${{ !cancelled() }}
    runs-on: ubuntu-24.04
    timeout-minutes: 5

    steps:
      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: extension-package

      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: '!{extension-package,github-pages}'

      - run: >-
          find . -type d -exec
          bash -c 'tree "$0" -h --du -D -H "/${GITHUB_REPOSITORY#*/}/${0:2}" -o "$0/index.html"' '{}'
          ';'

      - uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa # v3.0.1
        with:
          path: .
